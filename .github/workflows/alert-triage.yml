name: Alert Triage Agent

on:
  repository_dispatch:
    types: [alert_triage]

permissions:
  contents: read
  issues: write
  id-token: write

env:
  PROJECT_ID: alert-triage-playground
  PROJECT_NUMBER: "75832914099"
  WORKLOAD_IDENTITY_PROVIDER: projects/75832914099/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-triage-agent@alert-triage-playground.iam.gserviceaccount.com

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Parse alert payload
        id: alert
        run: |
          # Extract alert details from webhook payload
          INCIDENT_ID=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.incident_id // "unknown"')
          RESOURCE_NAME=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.resource_name // "unknown"')
          POLICY_NAME=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.policy_name // "unknown"')
          OBSERVED_VALUE=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.observed_value // "unknown"')
          THRESHOLD_VALUE=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.threshold_value // "unknown"')
          STARTED_AT=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.started_at // "unknown"')
          STATE=$(echo '${{ toJson(github.event.client_payload) }}' | jq -r '.incident.state // "open"')

          echo "incident_id=$INCIDENT_ID" >> $GITHUB_OUTPUT
          echo "resource_name=$RESOURCE_NAME" >> $GITHUB_OUTPUT
          echo "policy_name=$POLICY_NAME" >> $GITHUB_OUTPUT
          echo "observed_value=$OBSERVED_VALUE" >> $GITHUB_OUTPUT
          echo "threshold_value=$THRESHOLD_VALUE" >> $GITHUB_OUTPUT
          echo "started_at=$STARTED_AT" >> $GITHUB_OUTPUT
          echo "state=$STATE" >> $GITHUB_OUTPUT

          echo "Alert: $POLICY_NAME on $RESOURCE_NAME (value: $OBSERVED_VALUE)"

      - name: Check for duplicate issues
        id: duplicate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing issue with same incident ID from last 24 hours
          EXISTING=$(gh issue list \
            --search "incident:${{ steps.alert.outputs.incident_id }} in:body" \
            --state open \
            --json number,title \
            --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Found existing issue #$EXISTING for this incident"
            echo "existing_issue=$EXISTING" >> $GITHUB_OUTPUT
            echo "is_duplicate=true" >> $GITHUB_OUTPUT
          else
            echo "No duplicate found"
            echo "is_duplicate=false" >> $GITHUB_OUTPUT
          fi

      - name: Search historical issues
        id: history
        if: steps.duplicate.outputs.is_duplicate == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for similar past issues
          POLICY_NAME="${{ steps.alert.outputs.policy_name }}"
          RESOURCE_NAME="${{ steps.alert.outputs.resource_name }}"

          # Search by policy name
          HISTORY=$(gh issue list \
            --search "$POLICY_NAME in:title,body" \
            --state all \
            --limit 5 \
            --json number,title,labels,closedAt,body \
            --jq '[.[] | {number, title, labels: [.labels[].name], closedAt}]')

          echo "historical_issues<<EOF" >> $GITHUB_OUTPUT
          echo "$HISTORY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install Claude Code
        if: steps.duplicate.outputs.is_duplicate == 'false'
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude triage
        id: triage
        if: steps.duplicate.outputs.is_duplicate == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Build the triage prompt
          cat > /tmp/triage-prompt.txt << 'PROMPT_EOF'
          You are an SRE triage agent. Analyze this GCP Monitoring alert and create a triage report.

          ## Alert Details
          - **Incident ID**: ${{ steps.alert.outputs.incident_id }}
          - **Policy Name**: ${{ steps.alert.outputs.policy_name }}
          - **Resource**: ${{ steps.alert.outputs.resource_name }}
          - **Observed Value**: ${{ steps.alert.outputs.observed_value }}
          - **Threshold**: ${{ steps.alert.outputs.threshold_value }}
          - **Started At**: ${{ steps.alert.outputs.started_at }}
          - **State**: ${{ steps.alert.outputs.state }}

          ## Historical Context
          Previous similar issues:
          ${{ steps.history.outputs.historical_issues }}

          ## Your Tasks
          1. Query current GCP metrics using gcloud commands
          2. Check recent logs for errors
          3. Determine severity: CRITICAL, WARNING, or INFO
          4. Identify the likely cause based on patterns
          5. Recommend immediate actions

          ## CRITICAL: Output Requirements
          After your investigation, output this JSON (single line, no code blocks):

          {"severity":"WARNING","summary":"One sentence summary","analysis":"Detailed paragraph","infrastructure_status":[{"metric":"Pub/Sub Backlog","value":"120s","status":"warning"},{"metric":"Error Rate","value":"0%","status":"healthy"}],"recommended_action":"What to do","related_runbook":"pubsub-backlog.md","pattern":"Recurring issue, usually self-resolves","confidence":0.8}

          Field requirements:
          - severity: CRITICAL, WARNING, or INFO
          - infrastructure_status: Array of current metric readings with status (healthy/warning/critical)
          - pattern: Summarize if this is recurring, one-time, or new pattern based on historical issues
          - related_runbook: Suggest relevant runbook name or empty string
          The JSON must be valid. This is your final output.
          PROMPT_EOF

          # Load the system prompt
          SYSTEM_PROMPT=$(cat .claude/commands/sre-triage-agent.md 2>/dev/null || echo "You are an SRE triage agent.")

          # Default fallback JSON
          DEFAULT_JSON='{"severity":"WARNING","summary":"Triage incomplete - Claude execution failed","analysis":"The automated triage could not complete. This may be due to API issues or insufficient credits. Manual review is required.","metrics":{},"recommended_action":"Review the alert manually in GCP Console","related_runbook":"","confidence":0.3}'

          # Run Claude Code and capture output
          set +e
          RESULT=$(claude -p "$(cat /tmp/triage-prompt.txt)" \
            --allowedTools "Bash(gcloud*),Bash(curl*)" \
            --output-format json 2>&1)
          CLAUDE_EXIT=$?
          set -e

          echo "Claude exit code: $CLAUDE_EXIT"
          echo "Raw output: $RESULT"

          # Try to extract JSON from result
          # Claude Code outputs JSON with result field containing agent's text output

          TRIAGE_JSON=""

          # First: Check if output is Claude Code JSON format with .result field
          if echo "$RESULT" | jq -e '.result' >/dev/null 2>&1; then
            RESULT_TEXT=$(echo "$RESULT" | jq -r '.result')
            echo "Extracted result text: $RESULT_TEXT"

            # If result text is valid JSON with severity, use it directly
            if echo "$RESULT_TEXT" | jq -e '.severity' >/dev/null 2>&1; then
              TRIAGE_JSON="$RESULT_TEXT"
              echo "Result text is valid triage JSON"
            fi
          fi

          # Second: If still no JSON, check if raw result has severity
          if [ -z "$TRIAGE_JSON" ] && echo "$RESULT" | jq -e '.severity' >/dev/null 2>&1; then
            TRIAGE_JSON="$RESULT"
            echo "Raw result is valid triage JSON"
          fi

          # Fallback to default
          if [ -z "$TRIAGE_JSON" ] || ! echo "$TRIAGE_JSON" | jq -e '.severity' >/dev/null 2>&1; then
            echo "Could not parse Claude output, using default"
            TRIAGE_JSON="$DEFAULT_JSON"
          fi

          echo "Final triage JSON: $TRIAGE_JSON"

          echo "triage_result<<EOF" >> $GITHUB_OUTPUT
          echo "$TRIAGE_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        if: steps.duplicate.outputs.is_duplicate == 'false'
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Parse triage result
          TRIAGE='${{ steps.triage.outputs.triage_result }}'
          SEVERITY=$(echo "$TRIAGE" | jq -r '.severity // "WARNING"')
          SUMMARY=$(echo "$TRIAGE" | jq -r '.summary // "Alert triage completed"')
          ANALYSIS=$(echo "$TRIAGE" | jq -r '.analysis // "No analysis available"')
          RECOMMENDED_ACTION=$(echo "$TRIAGE" | jq -r '.recommended_action // "Review manually"')
          CONFIDENCE=$(echo "$TRIAGE" | jq -r '.confidence // 0.5')
          PATTERN=$(echo "$TRIAGE" | jq -r '.pattern // ""')
          RUNBOOK=$(echo "$TRIAGE" | jq -r '.related_runbook // ""')

          # Build infrastructure status table
          INFRA_TABLE=$(echo "$TRIAGE" | jq -r '
            if .infrastructure_status then
              .infrastructure_status | map(
                "| " + .metric + " | " + .value + " | " +
                (if .status == "healthy" then "âœ… Healthy"
                 elif .status == "warning" then "âš ï¸ Warning"
                 elif .status == "critical" then "ðŸ”´ Critical"
                 else .status end) + " |"
              ) | join("\n")
            else
              "| No metrics collected | - | - |"
            end
          ')

          # Build related issues section from historical context
          HISTORICAL='${{ steps.history.outputs.historical_issues }}'
          RELATED_ISSUES=""
          if [ -n "$HISTORICAL" ] && [ "$HISTORICAL" != "[]" ]; then
            RELATED_ISSUES=$(echo "$HISTORICAL" | jq -r '
              if length > 0 then
                map("| #" + (.number|tostring) + " | " + (.closedAt // "open") + " | " + ((.labels // []) | join(", ")) + " |") | join("\n")
              else
                ""
              end
            ' 2>/dev/null || echo "")
          fi

          # Map severity to label
          case $SEVERITY in
            CRITICAL) LABEL="severity:critical" ;;
            WARNING) LABEL="severity:warning" ;;
            *) LABEL="severity:info" ;;
          esac

          # Create issue body
          cat > /tmp/issue-body.md << ISSUE_EOF
          ## Alert Triage Report

          | Field | Value |
          |-------|-------|
          | **Verdict** | $SEVERITY |
          | **GCP Incident** | [${{ steps.alert.outputs.incident_id }}](https://console.cloud.google.com/monitoring/incidents/${{ steps.alert.outputs.incident_id }}?project=${{ env.PROJECT_ID }}) |
          | **Alert Policy** | ${{ steps.alert.outputs.policy_name }} |
          | **Resource** | ${{ steps.alert.outputs.resource_name }} |
          | **Observed Value** | ${{ steps.alert.outputs.observed_value }} (threshold: ${{ steps.alert.outputs.threshold_value }}) |
          | **Confidence** | ${CONFIDENCE} |

          ## Summary
          $SUMMARY

          ## Analysis
          $ANALYSIS

          ## Infrastructure Status
          | Metric | Value | Status |
          |--------|-------|--------|
          $INFRA_TABLE

          ## Recommended Action
          $RECOMMENDED_ACTION

          ISSUE_EOF

          # Add pattern if present
          if [ -n "$PATTERN" ]; then
            echo "" >> /tmp/issue-body.md
            echo "## Pattern" >> /tmp/issue-body.md
            echo "$PATTERN" >> /tmp/issue-body.md
          fi

          # Add related issues if present
          if [ -n "$RELATED_ISSUES" ]; then
            echo "" >> /tmp/issue-body.md
            echo "## Related Issues" >> /tmp/issue-body.md
            echo "| Issue | Closed | Labels |" >> /tmp/issue-body.md
            echo "|-------|--------|--------|" >> /tmp/issue-body.md
            echo "$RELATED_ISSUES" >> /tmp/issue-body.md
          fi

          # Add runbook if present
          if [ -n "$RUNBOOK" ]; then
            echo "" >> /tmp/issue-body.md
            echo "## Related Runbook" >> /tmp/issue-body.md
            echo "[\`$RUNBOOK\`](../runbooks/$RUNBOOK)" >> /tmp/issue-body.md
          fi

          # Add footer
          cat >> /tmp/issue-body.md << FOOTER_EOF

          ---
          *Automated triage by Claude Code Agent*
          *Incident: ${{ steps.alert.outputs.incident_id }}*
          FOOTER_EOF

          # Create issue
          ISSUE_URL=$(gh issue create \
            --title "[$SEVERITY] ${{ steps.alert.outputs.policy_name }}" \
            --body-file /tmp/issue-body.md \
            --label "$LABEL" \
            --label "triage")

          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "Created issue: $ISSUE_URL"

      - name: Comment on duplicate issue
        if: steps.duplicate.outputs.is_duplicate == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.duplicate.outputs.existing_issue }} \
            --body "**Alert Recurrence**

          This alert fired again at $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          - **Observed Value**: ${{ steps.alert.outputs.observed_value }}
          - **Threshold**: ${{ steps.alert.outputs.threshold_value }}
          - **State**: ${{ steps.alert.outputs.state }}"

      - name: Post to Google Chat
        if: always()
        env:
          CHAT_WEBHOOK_URL: ${{ secrets.GCHAT_WEBHOOK_URL }}
        run: |
          if [ -z "$CHAT_WEBHOOK_URL" ]; then
            echo "No Chat webhook configured, skipping"
            exit 0
          fi

          SEVERITY=$(echo '${{ steps.triage.outputs.triage_result }}' | jq -r '.severity // "INFO"' 2>/dev/null)

          case $SEVERITY in
            CRITICAL) EMOJI="ðŸ”´" ;;
            WARNING) EMOJI="ðŸŸ¡" ;;
            *) EMOJI="ðŸŸ¢" ;;
          esac

          if [ "${{ steps.duplicate.outputs.is_duplicate }}" == "true" ]; then
            MESSAGE="$EMOJI *Alert Recurrence*: ${{ steps.alert.outputs.policy_name }}\nExisting issue: https://github.com/${{ github.repository }}/issues/${{ steps.duplicate.outputs.existing_issue }}"
          else
            ISSUE_URL="${{ steps.issue.outputs.issue_url }}"
            MESSAGE="$EMOJI *$SEVERITY*: ${{ steps.alert.outputs.policy_name }}\nResource: ${{ steps.alert.outputs.resource_name }}\nIssue: $ISSUE_URL"
          fi

          curl -s -X POST "$CHAT_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$MESSAGE\"}"
